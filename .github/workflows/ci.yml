
name: Java CI with Maven and Docker Build


on:

  push:
    branches:
      - dev
      - main

  pull_request:
    branches:
      - dev
      - main


jobs:
  build-and-test:
    runs-on: ubuntu-latest 

    steps:
    - name: Kodu Çek (Checkout code)
      uses: actions/checkout@v4 

    - name: JDK 17 Kur (Set up JDK 17) 
      uses: actions/setup-java@v4
      with:
        java-version: '17' 
        distribution: 'temurin'
        cache: 'maven' 

    - name: Maven ile Derle ve Test Et (Build with Maven)
      run: mvn -B verify 


    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker
      uses: docker/login-action@v3
      with:

        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker Görüntüsünü Oluştur (Build Docker image)
      run: |

        IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/userservice-api" 

        if [[ "${{ github.ref_name }}" == "main" ]]; then
          TAG="latest" # main dalı için varsayılan etiket veya v1.0.0 gibi bir versiyon
        else
          TAG="${{ github.ref_name }}" # Diğer dallar için dal adını etiket olarak kullan
        fi

        docker build -t "$IMAGE_NAME:$TAG" .

        echo "DOCKER_IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_ENV"
        echo "DOCKER_IMAGE_TAG=$TAG" >> "$GITHUB_ENV"

    - name: Push Docker image
      run: docker push ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
